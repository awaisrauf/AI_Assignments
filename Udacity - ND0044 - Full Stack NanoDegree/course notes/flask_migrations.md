# Migrations with SQLAlchemy and Flask

Migrations are git version control for changes in data. It help us do quick rollback in case of error and test changes before applying them.
Flask-Migration library keep record of all the schema changes in a folder called migration where each file contain info about one version of our data. 

```bash
pip3 install Flask-Migrate
```

Simple script before using migrate, containg first version of our table
```python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///app.db'

db = SQLAlchemy(app)
migrate = Migrate(app, db)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128))
```

To start migrate, go to the folder where this code is and add run

```
flask db init
```

This will detect changes in teh model and will create migration file, 
```
flask db migrate
```
to commit chagnes
```
flask db upgrade
```
To rollback chagnes
```
flask db downgrade
```

### Example 

Lets assume that we already have a data strcutre like following

```Python
# models: create table for todo
class Todo(db.Model):
    __tablename__ = 'todos'
    id = db.Column(db.Integer, primary_key = True)
    description = db.Column(db.String(), nullable=False)
```
Now we want to add an extra column with nullable=False. But if our database already have data, this column will make issues as it will be NULL for existing rows. To get around it, we need to modify our migrate/-- file that contain upgrade function as follows;

```python
# models: create table for todo
class Todo(db.Model):
    __tablename__ = 'todos'
    id = db.Column(db.Integer, primary_key = True)
    description = db.Column(db.String(), nullable=False)
    completed = db.Column(db.Boolean(), nullable=True, default=False)

def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('todos', sa.Column('completed', sa.Boolean(), nullable=False))
    # following code was added by us
    op.excute('UPDATE todos SET completed = False WHERE completed is NULL;')
    op.alter_column('todos', 'completed', nullable=False)
    # ### end Alembic commands ###


```
   
